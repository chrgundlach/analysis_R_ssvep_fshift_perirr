---
title: "FFT_SSVEP_analysis"
author: "Christopher"
date: "2 7 2024"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    toc_depth: 4
    theme: flatly
---

Modelling of ~~raw~~ [*CSD based*] amplitude values from fft-based data
via linear mixed models
via standard anova models

```{r load_package, message = FALSE, warning = FALSE}
library(lme4)
library(readxl)
library(tidyverse)
library(data.table)
library(tidyverse)
library(afex)
library(broom)
library(apa)
library(kableExtra)
library(lmerTest)
library(pbkrtest)
library(effects)
library(visreg)
library(sjPlot)
library(broom.mixed)
library(pander)
library(mediation)
library(multcomp)
library(multcompView)
library(magrittr)
library(multipanelfigure)
library(ggbeeswarm)
library(lsmeans)
library(BayesFactor)
library(ggpubr)
library(gpairs)
library(DescTools)
library(cowplot)
library(ggpol)
library(logspline)

source('C:/Dropboxdata/Dropbox/work/R-statistics/general_functions/RainCloudPlots/tutorial_R/R_rainclouds.R')
source('C:/Dropboxdata/Dropbox/work/R-statistics/general_functions/RainCloudPlots/tutorial_R/R_rainclouds.R')

source('C:/Dropboxdata/Dropbox/work/R-statistics/examples/Bayesian_rank-based_hypothesis_testing/rankBasedCommonFunctions.R')
source('C:/Dropboxdata/Dropbox/work/R-statistics/examples/Bayesian_rank-based_hypothesis_testing/rankSumSampler.R') # Wilcoxon rank sum function
source('C:/Dropboxdata/Dropbox/work/R-statistics/examples/Bayesian_rank-based_hypothesis_testing/signRankSampler.R') # Wilcoxon signed-rank function
source('C:/Dropboxdata/Dropbox/work/R-statistics/examples/Bayesian_rank-based_hypothesis_testing/spearmanSampler.R')# Spearman's rho function




# broad cluster
# CSD based normalized to pre-cue baseline in %
#  
DATAPath = "data_in/FFT_Amp_data_largeclust_06-14-2024_13-19.csv"
t_baseline = c(-1000, 0)


# broad cluster | smaller central cluster
# CSD based normalized to pre-cue baseline in %
#  
# DATAPath = "data_in/FFT_Amp_data_largeclust_06-24-2024_15-43.csv"
# t_baseline = c(-1000, 0)


# broad cluster | smaller central cluster
# CSD based normalized to pre-cue baseline in %
# for changed experiment starting with participant 22: isoluminant stimuli and lower flicker frequencies
#  
DATAPath = "data_in/FFT_Amp_data_largeclust_allsubs_08-30-2024_11-21.csv"
t_baseline = c(-1000, 0)


# broad cluster | larger central cluster |
# peri: not correct!
# CSD based normalized to pre-cue baseline in %
# for changed experiment starting with participant 22: isoluminant stimuli and lower flicker frequencies
#  
# DATAPath = "data_in/FFT_Amp_data_pericenter_allsubs_07-02-2024_11-46.csv"
# t_baseline = c(-1000, 0)
# 
# broad cluster | very broad central cluster
# CSD based normalized to pre-cue baseline in %
# for changed experiment starting with participant 22: isoluminant stimuli and lower flicker frequencies
# # 
# DATAPath = "data_in/FFT_Amp_data_largecenterclust_allsubs_09-11-2024_14-45.csv"
# t_baseline = c(-1000, 0)



#!!!!!!! relevant
# broad cluster | larger central cluster as in Tango study | peri both clusters but smaller
# CSD based normalized to pre-cue baseline in %
# for changed experiment starting with participant 22: isoluminant stimuli and lower flicker frequencies
DATAPath = "data_in/FFT_Amp_data_CenterTangoStudyPeriSmall_05-23-2025_11-56.csv"
t_baseline = c(-1000, 0)

# broad cluster | larger central cluster as in Tango study | peri only center
# DATAPath = "data_in/FFT_Amp_data_TangoStudyPeriOnlyCenter_11-25-2024_14-17.csv"
# t_baseline = c(-1000, 0)

# # broad cluster | larger central cluster as in Tango study | peri only lateral | in this study shows gain for attended
# DATAPath = "data_in/FFT_Amp_data_TangoStudyPeriOnlyLateral_11-25-2024_14-17.csv"
# t_baseline = c(-1000, 0)


#!!!!!!!


# replication relevant
# broad cluster | larger central cluster as in Tango study | peri both clusters as in Tango study
# CSD based normalized to pre-cue baseline in %
# for changed experiment starting with participant 22: isoluminant stimuli and lower flicker frequencies
# DATAPath = "data_in/FFT_Amp_data_TangoStudy_05-23-2025_11-53.csv"
# t_baseline = c(-1000, 0)




options(scipen=1, digits=7)
```
<style type="text/css">
.main-container {
max-width: 1800px !important;
margin-left: auto;
margin-right: auto;
}
</style>


## Prepare data  
<br>  

1.  Read in data: 
+ `r DATAPath`
+ with pre-cue  [`r toString(t_baseline)`] ms

<br>  

```{r load_data,results = "hide", fig.show = "hide", warning = FALSE}
sub_sample = c(0)
# sub_sample = as.factor(c(26,30, 31,37, 38)) # no ssvep people discarded
sub_sample = as.factor(c(42)) # low trial number


# read in data
DataIn <- read.csv(DATAPath, sep = ";") %>%
  mutate(subjects = as.factor(subjects))%>%
  filter(!subjects %in% sub_sample)
head(DataIn)
str(DataIn)
```
## Illustrate SSVEP Data

### 1a  Illustrate Data as is | center RDKs

<br>  

```{r plot_data_st_center, results = "hide",  fig.height=3, fig.width=4, warning = FALSE}
#evoked raw#### for center
dat2plot <- DataIn %>%
  filter(RDK_position2=="center") %>%
  group_by(subjects, time, RDK_isattended, RDK_colorlum)%>%
  summarise(amplitude_evoked=mean(amplitude_evoked), modulation_evoked=mean(modulation_evoked), subtraction_evoked=mean(subtraction_evoked))

theme_set(theme_bw())
ggplot(dat2plot, aes(x = interaction(time,RDK_isattended), y = amplitude_evoked, fill = RDK_isattended)) +
  # geom_hline(yintercept=0, show.legend = FALSE) +
  geom_line(aes(group = interaction(subjects,RDK_isattended)),colour = "grey60",alpha = 0.5,size =0.5) +
  geom_beeswarm(aes(color = RDK_isattended, x = interaction(time,RDK_isattended),
                    group = RDK_isattended), cex=2, size = 3,alpha=1,fill="grey40",shape=21)+
  # geom_point(aes(color = condition, x = interaction(time,condition),
  #                   group = condition), size = 4,alpha=0.4)+
  stat_summary(fun.y=mean, aes(ymin=..y.., ymax=..y.., color =RDK_isattended), geom='errorbar', width=0.9, size=1.5) +
  scale_x_discrete("time windows in s", breaks=waiver(), labels = rep(c("[-1 0]","[0.5 1.5]","[1 2]"),1,6)) +
  facet_grid(.~RDK_colorlum)+
  theme(legend.position="bottom") +
  ylab(expression(paste("amplitude in muV/cm²")))+
  labs(title=sprintf("SSVEP amplitudes | evoked"),
       subtitle="collapsed across frequencies")+
  scale_fill_brewer(palette = "Dark2")+
  scale_color_brewer(palette = "Dark2")


theme_set(theme_bw())
ggplot(dat2plot, aes(x = interaction(time,RDK_isattended), y = modulation_evoked, fill = RDK_isattended)) +
  # geom_hline(yintercept=0, show.legend = FALSE) +
  geom_line(aes(group = interaction(subjects,RDK_isattended)),colour = "grey60",alpha = 0.5,size =0.5) +
  geom_beeswarm(aes(color = RDK_isattended, x = interaction(time,RDK_isattended),
                    group = RDK_isattended), cex=2, size = 3,alpha=1,fill="grey40",shape=21)+
  # geom_point(aes(color = condition, x = interaction(time,condition),
  #                   group = condition), size = 4,alpha=0.4)+
  stat_summary(fun.y=mean, aes(ymin=..y.., ymax=..y.., color =RDK_isattended), geom='errorbar', width=0.9, size=1.5) +
  scale_x_discrete("time windows in s", breaks=waiver(), labels = rep(c("[-1 0]","[0.5 1.5]","[1 2]"),1,6)) +
  facet_grid(.~RDK_colorlum)+
  theme(legend.position="bottom") +
  ylab(expression(paste("modulation in %")))+
  labs(title=sprintf("SSVEP amplitudes | evoked"),
       subtitle="collapsed across frequencies")+
  scale_fill_brewer(palette = "Dark2")+
  scale_color_brewer(palette = "Dark2")

theme_set(theme_bw())
ggplot(dat2plot, aes(x = interaction(time,RDK_isattended), y = subtraction_evoked, fill = RDK_isattended)) +
  # geom_hline(yintercept=0, show.legend = FALSE) +
  geom_line(aes(group = interaction(subjects,RDK_isattended)),colour = "grey60",alpha = 0.5,size =0.5) +
  geom_beeswarm(aes(color = RDK_isattended, x = interaction(time,RDK_isattended),
                    group = RDK_isattended), cex=2, size = 3,alpha=1,fill="grey40",shape=21)+
  # geom_point(aes(color = condition, x = interaction(time,condition),
  #                   group = condition), size = 4,alpha=0.4)+
  stat_summary(fun.y=mean, aes(ymin=..y.., ymax=..y.., color =RDK_isattended), geom='errorbar', width=0.9, size=1.5) +
  scale_x_discrete("time windows in s", breaks=waiver(), labels = rep(c("[-1 0]","[0.5 1.5]","[1 2]"),1,6)) +
  facet_grid(.~RDK_colorlum)+
  theme(legend.position="bottom") +
  ylab(expression(paste("amplitude diff in muV/cm²")))+
  labs(title=sprintf("SSVEP amplitudes | evoked"),
       subtitle="collapsed across frequencies")+
  scale_fill_brewer(palette = "Dark2")+
  scale_color_brewer(palette = "Dark2")
```
### 1b  Illustrate Data as is | center RDKs

plot differently

<br>  

```{r plot_data_st_center_2, results = "hide",  fig.height=5, fig.width=3.5, warning = FALSE}
#evoked raw#### for center

# set overall limits?
dat2plot <- DataIn %>%
  filter(RDK_position2=="center") %>%
  group_by(subjects, time, RDK_isattended, RDK_colorlum)%>%
  summarise(amplitude_evoked=mean(amplitude_evoked), modulation_evoked=mean(modulation_evoked))%>%
  filter(time=='[0.5 1.5] ')
# set limits
yax_limits <- c( min(dat2plot$modulation_evoked), max(dat2plot$modulation_evoked))
yax_limits <- round(yax_limits + c(-1, 1)*diff(yax_limits)*0.1)
yax_limits <- yax_limits + c(-1, 1)*diff(yax_limits)*0.1


dat2plot <- DataIn %>%
  filter(RDK_position2=="center") %>%
  group_by(subjects, time, RDK_isattended, RDK_colorlum)%>%
  summarise(amplitude_evoked=mean(amplitude_evoked), modulation_evoked=mean(modulation_evoked))%>%
  filter(time=='[0.5 1.5] ', RDK_colorlum == 'offset_to_bckgrd')

# set limits
# yax_limits <- c( min(dat2plot$modulation_evoked), max(dat2plot$modulation_evoked))
# yax_limits <- round(yax_limits + c(-1, 1)*diff(yax_limits)*0.1)
# yax_limits <- yax_limits + c(-1, 1)*diff(yax_limits)*0.2
# # yax_limits <- c(-27, 15)

theme_set(theme_bw())
plot1 <- ggplot(dat2plot, aes(x = RDK_isattended, y = modulation_evoked, fill = RDK_isattended)) +
  geom_hline(yintercept=0, show.legend = FALSE) +
  geom_line(aes(group = interaction(subjects,time)),colour = "grey60",alpha = 1,size =0.5) +
  geom_beeswarm(aes(color = RDK_isattended, x = RDK_isattended,
                    group = RDK_isattended), cex=3, size = 5,alpha=1,fill="grey40",shape=21)+
  # geom_point(aes(color = RDK_isattended, x = interaction(time,RDK_isattended),
  #                   group = RDK_isattended), size = 4,alpha=0.4)+
  stat_summary(fun.y=mean, aes(ymin=..y.., ymax=..y.., color =RDK_isattended), geom='errorbar', width=0.9, size=1.5) +
  scale_x_discrete("RDK_isattended", breaks=waiver(), labels = rep(c(""),1,2)) +
  # theme(legend.position="bottom") +
  ylab(expression(paste("amplitude modulation in %")))+
  scale_fill_manual(values=c("steelblue2", "#F03F3F"))+
  scale_color_manual(values=c("steelblue2", "#F03F3F"))+
  #  scale_fill_manual(values=c("#193A3D", "#F03F3F"))+
  # scale_color_manual(values=c("#193A3D", "#F03F3F"))+
  # scale_fill_manual(values=c(rgb2hex(0.0, 153.0, 204.0),rgb2hex(0.0, 77, 102.0)))+
  # scale_color_manual(values=c(rgb2hex(0.0, 153.0, 204.0),rgb2hex(0.0, 77, 102.0)))+
  theme(legend.position="none")+
  # scale_y_continuous(limits=c(-60, 140))
  scale_y_continuous(limits=yax_limits)


plot2 <- ggplot(dat2plot, aes(y = modulation_evoked, fill = RDK_isattended, x = 1)) +
  geom_flat_violin(aes(fill = RDK_isattended),position = position_nudge(x = .1, y = 0), 
                   adjust = 1.3, trim = FALSE, alpha = 1, colour = NA)+
  geom_hline(yintercept=0, show.legend = FALSE) +
  # scale_fill_manual(values=c("#193A3D", "#F03F3F"))+
  # scale_color_manual(values=c("#193A3D", "#F03F3F"))+
  scale_fill_manual(values=c("steelblue2", "#F03F3F"))+
  scale_color_manual(values=c("steelblue2", "#F03F3F"))+
  # scale_fill_manual(values=c(rgb2hex(0.0, 153.0, 204.0),rgb2hex(0.0, 77, 102.0)))+
  # scale_color_manual(values=c(rgb2hex(0.0, 153.0, 204.0),rgb2hex(0.0, 77, 102.0)))+
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())+
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  # scale_y_continuous(limits=c(-60, 140))
  scale_y_continuous(limits=yax_limits)



# cowplot::plot_grid(plot1, plot2, plot3, ncol = 3,labels = "AUTO")
plotttitle <- ggdraw() + 
  draw_label("SSVEP mod. | evoked \ncentral RDKs | luminance offset", fontface='bold', size = 10)
plotplots <- ggarrange(plot1, plot2,ncol = 2,common.legend = TRUE,align = "h", widths=c(3,1))

savefig <- multi_panel_figure(columns = 1, rows = 1, panel_label_type = "none", width = 3.5, height = 5, unit = "in")
saveplot <- ggarrange(plotttitle, plotplots, nrow = 2, heights=c(0.2, 1))

savefig %<>%
  fill_panel(saveplot, column = 1, row = 1)
savefig
# save_multi_panel_figure(savefig, "figures/FFT_BeeSwarm_Mod_ALPHA_COL_34subs.eps")




dat2plot <- DataIn %>%
  filter(RDK_position2=="center") %>%
  group_by(subjects, time, RDK_isattended, RDK_colorlum)%>%
  summarise(amplitude_evoked=mean(amplitude_evoked), modulation_evoked=mean(modulation_evoked))%>%
  filter(time=='[0.5 1.5] ', RDK_colorlum == 'isolum__to_bckgrd')


# set limits
# yax_limits <- c( min(dat2plot$modulation_evoked), max(dat2plot$modulation_evoked))
# yax_limits <- round(yax_limits + c(-1, 1)*diff(yax_limits)*0.1)
# yax_limits <- yax_limits + c(-1, 1)*diff(yax_limits)*0.2
# # yax_limits <- c(-27, 15)

theme_set(theme_bw())
plot1 <- ggplot(dat2plot, aes(x = RDK_isattended, y = modulation_evoked, fill = RDK_isattended)) +
  geom_hline(yintercept=0, show.legend = FALSE) +
  geom_line(aes(group = interaction(subjects,time)),colour = "grey60",alpha = 1,size =0.5) +
  geom_beeswarm(aes(color = RDK_isattended, x = RDK_isattended,
                    group = RDK_isattended), cex=3, size = 5,alpha=1,fill="grey40",shape=21)+
  # geom_point(aes(color = RDK_isattended, x = interaction(time,RDK_isattended),
  #                   group = RDK_isattended), size = 4,alpha=0.4)+
  stat_summary(fun.y=mean, aes(ymin=..y.., ymax=..y.., color =RDK_isattended), geom='errorbar', width=0.9, size=1.5) +
  scale_x_discrete("RDK_isattended", breaks=waiver(), labels = rep(c(""),1,2)) +
  # theme(legend.position="bottom") +
  ylab(expression(paste("amplitude modulation in %")))+
  scale_fill_manual(values=c("steelblue2", "#F03F3F"))+
  scale_color_manual(values=c("steelblue2", "#F03F3F"))+
  #  scale_fill_manual(values=c("#193A3D", "#F03F3F"))+
  # scale_color_manual(values=c("#193A3D", "#F03F3F"))+
  # scale_fill_manual(values=c(rgb2hex(0.0, 153.0, 204.0),rgb2hex(0.0, 77, 102.0)))+
  # scale_color_manual(values=c(rgb2hex(0.0, 153.0, 204.0),rgb2hex(0.0, 77, 102.0)))+
  theme(legend.position="none")+
  # scale_y_continuous(limits=c(-60, 140))
  scale_y_continuous(limits=yax_limits)


plot2 <- ggplot(dat2plot, aes(y = modulation_evoked, fill = RDK_isattended, x = 1)) +
  geom_flat_violin(aes(fill = RDK_isattended),position = position_nudge(x = .1, y = 0), 
                   adjust = 1.3, trim = FALSE, alpha = 1, colour = NA)+
  geom_hline(yintercept=0, show.legend = FALSE) +
  # scale_fill_manual(values=c("#193A3D", "#F03F3F"))+
  # scale_color_manual(values=c("#193A3D", "#F03F3F"))+
  scale_fill_manual(values=c("steelblue2", "#F03F3F"))+
  scale_color_manual(values=c("steelblue2", "#F03F3F"))+
  # scale_fill_manual(values=c(rgb2hex(0.0, 153.0, 204.0),rgb2hex(0.0, 77, 102.0)))+
  # scale_color_manual(values=c(rgb2hex(0.0, 153.0, 204.0),rgb2hex(0.0, 77, 102.0)))+
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())+
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  # scale_y_continuous(limits=c(-60, 140))
  scale_y_continuous(limits=yax_limits)



# cowplot::plot_grid(plot1, plot2, plot3, ncol = 3,labels = "AUTO")
plotttitle <- ggdraw() + 
  draw_label("SSVEP mod. | evoked \ncentral RDKs | isoluminant to background", fontface='bold', size = 10)
plotplots <- ggarrange(plot1, plot2,ncol = 2,common.legend = TRUE,align = "h", widths=c(3,1))

savefig <- multi_panel_figure(columns = 1, rows = 1, panel_label_type = "none", width = 3.5, height = 5, unit = "in")
saveplot <- ggarrange(plotttitle, plotplots, nrow = 2, heights=c(0.2, 1))

savefig %<>%
  fill_panel(saveplot, column = 1, row = 1)
savefig
# save_multi_panel_figure(savefig, "figures/FFT_BeeSwarm_Mod_ALPHA_COL_34subs.eps")



dat2plot <- DataIn %>%
  filter(RDK_position2=="center") %>%
  group_by(subjects, time, RDK_isattended, RDK_colorlum)%>%
  summarise(amplitude_evoked=mean(amplitude_evoked), modulation_evoked=mean(modulation_evoked), subtraction_evoked = mean(subtraction_evoked))%>%
  filter(time=='[0.5 1.5] ', RDK_colorlum == 'isolum__to_bckgrd')


# set limits
yax_limits <- c( min(dat2plot$subtraction_evoked), max(dat2plot$subtraction_evoked))
# yax_limits <- round(yax_limits + c(-1, 1)*diff(yax_limits)*0.1)
yax_limits <- yax_limits + c(-1, 1)*diff(yax_limits)*0.2
# # yax_limits <- c(-27, 15)

theme_set(theme_bw())
plot1 <- ggplot(dat2plot, aes(x = RDK_isattended, y = subtraction_evoked, fill = RDK_isattended)) +
  geom_hline(yintercept=0, show.legend = FALSE) +
  geom_line(aes(group = interaction(subjects,time)),colour = "grey60",alpha = 1,size =0.5) +
  geom_beeswarm(aes(color = RDK_isattended, x = RDK_isattended,
                    group = RDK_isattended), cex=3, size = 5,alpha=1,fill="grey40",shape=21)+
  # geom_point(aes(color = RDK_isattended, x = interaction(time,RDK_isattended),
  #                   group = RDK_isattended), size = 4,alpha=0.4)+
  stat_summary(fun.y=mean, aes(ymin=..y.., ymax=..y.., color =RDK_isattended), geom='errorbar', width=0.9, size=1.5) +
  scale_x_discrete("RDK_isattended", breaks=waiver(), labels = rep(c(""),1,2)) +
  # theme(legend.position="bottom") +
  ylab(expression(paste("amplitude diff in muV/cm²")))+
  scale_fill_manual(values=c("steelblue2", "#F03F3F"))+
  scale_color_manual(values=c("steelblue2", "#F03F3F"))+
  #  scale_fill_manual(values=c("#193A3D", "#F03F3F"))+
  # scale_color_manual(values=c("#193A3D", "#F03F3F"))+
  # scale_fill_manual(values=c(rgb2hex(0.0, 153.0, 204.0),rgb2hex(0.0, 77, 102.0)))+
  # scale_color_manual(values=c(rgb2hex(0.0, 153.0, 204.0),rgb2hex(0.0, 77, 102.0)))+
  theme(legend.position="none")+
  # scale_y_continuous(limits=c(-60, 140))
  scale_y_continuous(limits=yax_limits)


plot2 <- ggplot(dat2plot, aes(y = subtraction_evoked, fill = RDK_isattended, x = 1)) +
  geom_flat_violin(aes(fill = RDK_isattended),position = position_nudge(x = .1, y = 0), 
                   adjust = 1.3, trim = FALSE, alpha = 1, colour = NA)+
  geom_hline(yintercept=0, show.legend = FALSE) +
  # scale_fill_manual(values=c("#193A3D", "#F03F3F"))+
  # scale_color_manual(values=c("#193A3D", "#F03F3F"))+
  scale_fill_manual(values=c("steelblue2", "#F03F3F"))+
  scale_color_manual(values=c("steelblue2", "#F03F3F"))+
  # scale_fill_manual(values=c(rgb2hex(0.0, 153.0, 204.0),rgb2hex(0.0, 77, 102.0)))+
  # scale_color_manual(values=c(rgb2hex(0.0, 153.0, 204.0),rgb2hex(0.0, 77, 102.0)))+
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())+
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  # scale_y_continuous(limits=c(-60, 140))
  scale_y_continuous(limits=yax_limits)



# cowplot::plot_grid(plot1, plot2, plot3, ncol = 3,labels = "AUTO")
plotttitle <- ggdraw() + 
  draw_label("SSVEP diff. | evoked \ncentral RDKs | isoluminant to background", fontface='bold', size = 10)
plotplots <- ggarrange(plot1, plot2,ncol = 2,common.legend = TRUE,align = "h", widths=c(3,1))

savefig <- multi_panel_figure(columns = 1, rows = 1, panel_label_type = "none", width = 3.5, height = 5, unit = "in")
saveplot <- ggarrange(plotttitle, plotplots, nrow = 2, heights=c(0.2, 1))

savefig %<>%
  fill_panel(saveplot, column = 1, row = 1)
savefig
# save_multi_panel_figure(savefig, "figures/FFT_BeeSwarm_Mod_ALPHA_COL_34subs.eps")
```


### 2a  Illustrate Data as is | both subsets | general modulation

plot differently

<br>  

```{r plot_data_center_postcue, results = "hide",  fig.height=5, fig.width=3.5, warning = FALSE}
#evoked raw#### for center

# set overall limits?
dat2plot <- DataIn %>%
  filter(RDK_ispresented=="presented", RDK_position1=="center")%>%
  group_by(subjects, time, RDK_colorlum)%>%
  summarise(amplitude_evoked=mean(amplitude_evoked), modulation_evoked=mean(modulation_evoked))%>%
  filter(time == '[0.5 1.5] ')
# set limits
yax_limits <- c( min(dat2plot$modulation_evoked), max(dat2plot$modulation_evoked))
yax_limits <- round(yax_limits + c(-1, 1)*diff(yax_limits)*0.1)
yax_limits <- yax_limits + c(-1, 1)*diff(yax_limits)*0.1




theme_set(theme_bw())
plot1 <- ggplot(dat2plot, aes(x = RDK_colorlum, y = modulation_evoked, fill = RDK_colorlum)) +
  geom_hline(yintercept=0, show.legend = FALSE) +
  # geom_line(aes(group = interaction(subjects,time)),colour = "grey60",alpha = 1,size =0.5) +
  geom_beeswarm(aes(color = RDK_colorlum, x = RDK_colorlum,
                    group = RDK_colorlum), cex=3, size = 5,alpha=1,fill="grey60",shape=21)+
  # geom_point(aes(color = RDK_isattended, x = interaction(time,RDK_isattended),
  #                   group = RDK_isattended), size = 4,alpha=0.4)+
  stat_summary(fun.y=mean, aes(ymin=..y.., ymax=..y.., color =RDK_colorlum), geom='errorbar', width=0.9, size=1.5) +
  scale_x_discrete("RDK position", breaks=waiver(), labels = rep(c(""),1,2)) +
  # theme(legend.position="bottom") +
  ylab(expression(paste("amplitude modulation in %")))+
  scale_fill_manual(values=c("seagreen", "plum4"))+
  scale_color_manual(values=c("seagreen", "plum4"))+
  #  scale_fill_manual(values=c("#193A3D", "#F03F3F"))+
  # scale_color_manual(values=c("#193A3D", "#F03F3F"))+
  # scale_fill_manual(values=c(rgb2hex(0.0, 153.0, 204.0),rgb2hex(0.0, 77, 102.0)))+
  # scale_color_manual(values=c(rgb2hex(0.0, 153.0, 204.0),rgb2hex(0.0, 77, 102.0)))+
  theme(legend.position="none")+
  # scale_y_continuous(limits=c(-60, 140))
  scale_y_continuous(limits=yax_limits)


plot2 <- ggplot(dat2plot, aes(y = modulation_evoked, fill = RDK_colorlum, x = 1)) +
  geom_flat_violin(aes(fill = RDK_colorlum),position = position_nudge(x = .1, y = 0), 
                   adjust = 1.3, trim = FALSE, alpha = 1, colour = NA)+
  geom_hline(yintercept=0, show.legend = FALSE) +
  # scale_fill_manual(values=c("#193A3D", "#F03F3F"))+
  # scale_color_manual(values=c("#193A3D", "#F03F3F"))+
  scale_fill_manual(values=c("seagreen", "plum4"))+
  scale_color_manual(values=c("seagreen", "plum4"))+
  # scale_fill_manual(values=c(rgb2hex(0.0, 153.0, 204.0),rgb2hex(0.0, 77, 102.0)))+
  # scale_color_manual(values=c(rgb2hex(0.0, 153.0, 204.0),rgb2hex(0.0, 77, 102.0)))+
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())+
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  # scale_y_continuous(limits=c(-60, 140))
  scale_y_continuous(limits=yax_limits)



# cowplot::plot_grid(plot1, plot2, plot3, ncol = 3,labels = "AUTO")
plotttitle <- ggdraw() + 
  draw_label("SSVEP mod. | evoked \nacross cons | by stimuli brightness",
             fontface='bold', size = 10)
plotplots <- ggarrange(plot1, plot2,ncol = 2,common.legend = TRUE,align = "h", widths=c(3,1))

savefig <- multi_panel_figure(columns = 1, rows = 1, panel_label_type = "none", width = 3.5, height = 5, unit = "in")
saveplot <- ggarrange(plotttitle, plotplots, nrow = 2, heights=c(0.2, 1))

savefig %<>%
  fill_panel(saveplot, column = 1, row = 1)
savefig
# save_multi_panel_figure(savefig, "figures/FFT_BeeSwarm_Mod_ALPHA_COL_34subs.eps")
```



## Statistical analysis



### Central Stimuli

#### analysis I

**modulation** ~ **COLOR ATTENTION** x **COLOR LUMINANCE**

- mixed design
- t-test post-cue modulation against zero for attended and unattended color
- t-test difference of post-cue modulation for attended vs unattended color

<br> 

```{r Stat central stimuli analysisI, message=FALSE, warning=FALSE, include=TRUE, fig.height=4, fig.width=4.5}
dat2plot <- DataIn %>%
  filter(RDK_position2=="center") %>%
  group_by(subjects, time, RDK_isattended, RDK_colorlum)%>%
  summarise(amplitude_evoked=mean(amplitude_evoked), modulation_evoked=mean(modulation_evoked))%>%
  filter(time == '[0.5 1.5] ')%>%
  ungroup

aovmodel1 <- dat2plot%>%
  aov_ez(id="subjects", dv = "modulation_evoked", data = ., within = c("RDK_isattended"), between = c("RDK_colorlum"),
         include_aov = afex_options("include_aov"))


# display table anova effects
aovmodel1 %>%
  anova()%>%
  tidy()%>%
  mutate(
    `p.value` = cell_spec(ifelse(round(`p.value`,4)<.001,"< .001",round(`p.value`,4)), 
                        color = ifelse(is.nan(`p.value`),"blue", ifelse(`p.value` < .05, "green", "red")),
                        bold = ifelse(is.nan(`p.value`),F, ifelse(`p.value` < .05, T,F)),
                        align = "center")
  ) %>%
  dplyr::select(term, `num.Df`, `den.Df`, MSE, `statistic`, ges, `p.value`) %>%
  dplyr::rename(F=statistic)%>%
  kbl(escape = F, digits = c(5,5,5,5,5,5,5,5,5), caption = c("repeated measures ANOVA for central post-cue modulations")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))


#display interaction
emm_ATTXLum <- as.data.frame(emmeans(aovmodel1, ~ RDK_isattended*RDK_colorlum))

# RDK_isattended plot
ggplot(emm_ATTXLum, aes(x = RDK_colorlum, y = emmean, fill = RDK_isattended)) +
  geom_col(position = position_dodge(), width = 0.6) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), 
                position = position_dodge(width = 0.6),
                width = 0.2) +
  labs(title = "Interaction: Attention × Luminance",
       y = "Estimated Marginal Means (95% CI)", x = "Color Luminance") +
  theme_minimal()+
  scale_fill_manual(values=c("steelblue2", "#F03F3F"))+
  scale_color_manual(values=c("steelblue2", "#F03F3F"))


#create emmeans object/grid
post_hocs.emmean <- emmeans(aovmodel1, c("RDK_isattended","RDK_colorlum")) # adjust = holm

# report data for post_hocs.RDK_isattended
post_hocs.emmean %>%
  kbl(escape = F, digits = c(3,3,3,3,3,3,3,3,3), 
      caption = c("estimated marginal means | by ATTENTION X LUMINANCE | dv = central SSVEP modulation")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))

post_hocs.emmean %>%
contrast(method = "identity",adjust = "FDR")%>%
summary() %>%
  mutate(
    p.value = cell_spec(ifelse(round(p.value,4)<.001,"< .001",round(p.value,4)), 
                        color = ifelse(is.nan(p.value),"blue", ifelse(p.value < .05, "green", "red")),
                        bold = ifelse(is.nan(p.value),F, ifelse(p.value < .05, T,F)),
                        align = "left")
  ) %>%
  # mutate(CohensD = `t.ratio`/sqrt(df+1))%>%
  mutate(`CohensD` =
           summary(eff_size(contrast(post_hocs.emmean,method = "identity",adjust = "FDR"),
                            sigma = sqrt(mean(sigma(aovmodel1$lm)^2)), # RMS of sigma()
                            edf = df.residual(aovmodel1$lm), method = "identity"))$effect.size,
         `lowCI` =
           summary(eff_size(contrast(post_hocs.emmean,method = "identity",adjust = "FDR"),
                            sigma = sqrt(mean(sigma(aovmodel1$lm)^2)), # RMS of sigma()
                            edf = df.residual(aovmodel1$lm), method = "identity"))$lower.CL,
         `highCI` =
           summary(eff_size(contrast(post_hocs.emmean,method = "identity",adjust = "FDR"),
                            sigma = sqrt(mean(sigma(aovmodel1$lm)^2)), # RMS of sigma()
                            edf = df.residual(aovmodel1$lm), method = "identity"))$upper.CL
  )%>%
  kbl(escape = F, digits = c(3,3,3,3,3,3,3,3,3), 
        caption = c("estimated marginal means | by ATTENTION X LUMINANCE | dv = central SSVEP modulation | corrected: FDR")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))

# planned comparison
# test by specifying the levels levels(post_hocs.emmean) as.data.frame(post_hocs.emmean)
list.contrasts <- list(
  "iso att vs unatt"=c(1, -1, 0, 0),
  "offset att vs unatt"=c(0, 0, 1, -1),
  "att iso vs offset"=c(1,0,-1,0),
  "unatt iso vs offset"=c(0, 1, 0, -1)
)



post_hocs.emmean %>%
  contrast(method = list.contrasts,adjust = "FDR") %>%
  summary() %>%
  mutate(
    p.value = cell_spec(ifelse(round(p.value,4)<.001,"< .001",round(p.value,4)), 
                        color = ifelse(is.nan(p.value),"blue", ifelse(p.value < .05, "green", "red")),
                        bold = ifelse(is.nan(p.value),F, ifelse(p.value < .05, T,F)),
                        align = "left")
  ) %>%
  # mutate(CohensD = `t.ratio`/sqrt(df+1))%>%
  mutate(`CohensD` =
           summary(eff_size(contrast(post_hocs.emmean, method = list.contrasts,adjust = "FDR"),
                            sigma = sqrt(mean(sigma(aovmodel1$lm)^2)), # RMS of sigma()
                            edf = df.residual(aovmodel1$lm), method = "identity"))$effect.size,
         `lowCI` =
           summary(eff_size(contrast(post_hocs.emmean, method = list.contrasts,adjust = "FDR"),
                            sigma = sqrt(mean(sigma(aovmodel1$lm)^2)), # RMS of sigma()
                            edf = df.residual(aovmodel1$lm), method = "identity"))$lower.CL,
         `highCI` =
           summary(eff_size(contrast(post_hocs.emmean, method = list.contrasts,adjust = "FDR"),
                            sigma = sqrt(mean(sigma(aovmodel1$lm)^2)), # RMS of sigma()
                            edf = df.residual(aovmodel1$lm), method = "identity"))$upper.CL
  )%>%
  kbl(escape = F, digits = c(3,3,3,3,3,3,3,3,3), 
        caption = c("estimated contrasts | by ATTENTION X LUMINANCE | dv = central SSVEP modulation | corrected: FDR")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))
```




#### analysis II

**modulation** ~ **COLOR ATTENTION**

- t-test post-cue modulation against zero for attended and unattended color
- t-test difference of post-cue modulation for attended vs unattended color

<br> 

```{r Stat central stimuli analysisII, message=FALSE, warning=FALSE, include=TRUE}
dat2plot <- DataIn %>%
  filter(RDK_position2=="center") %>%
  group_by(subjects, time, RDK_isattended, RDK_colorlum)%>%
  summarise(amplitude_evoked=mean(amplitude_evoked), modulation_evoked=mean(modulation_evoked))%>%
  filter(time == '[0.5 1.5] ')

dat2plot %>%
  group_by(RDK_isattended, RDK_colorlum)%>%
  nest()%>%
  mutate(stats = map(data, ~broom::tidy(
    t.test(modulation_evoked ~ 1, data = .)
  ))) %>%
  mutate(
    t_test_bf = map(data, ~{extractBF(ttestBF(x = .$modulation_evoked, data = .,iterations=num.iter,rscale = sqrt(2)/2))})
  )%>%
  mutate(meanval = map(data, ~ mean(.x$modulation_evoked))) %>%
  mutate(std = map(data, ~ sd(.x$modulation_evoked))) %>%
  dplyr::select(-data) %>%
  unnest(cols = c(stats, t_test_bf, meanval, std))%>%
  mutate(BF10 = bf, BF01 = 1/bf)%>%
  dplyr::select(RDK_colorlum, RDK_isattended, meanval, std,  statistic, parameter, p.value, BF10, BF01)%>%
  ungroup()%>%
  # group_by(RDK_colorlum)%>%
  mutate(p.value = p.adjust(p.value, method="fdr")) %>% # none, holm
  # mutate(p.value = p.adjust(p.value, method="none")) %>% # none, holm
  ungroup()%>%
  mutate(CohensD = `statistic`/sqrt(parameter +1))%>%
  mutate(
    p.value = cell_spec(ifelse(round(p.value,4)<.001,"< .001",round(p.value,4)), 
                        color = ifelse(is.nan(p.value),"blue", ifelse(p.value < .05, "green", "red")),
                        bold = ifelse(is.nan(p.value),F, ifelse(p.value < .05, T,F)),
                        align = "center")
  ) %>%
  kbl(escape = F, digits = c(3,3,3,3,3,3,3,3,3), 
        caption = c("central SSVEP | modulation | t-tests for modulation agains zero | FDR-corrected")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))



dat2plot %>%
  dplyr::select(-amplitude_evoked)%>%
  pivot_wider(names_from = "RDK_isattended", values_from = "modulation_evoked")%>%
  mutate(attendedMINUSunattended = `attended` -`not attended`)%>%
  group_by(time, RDK_colorlum)%>%
  nest()%>%
  mutate(stats = map(data, ~broom::tidy(
    t.test(attendedMINUSunattended ~ 1, data = .)
  ))) %>%
  mutate(
    t_test_bf = map(data, ~{extractBF(ttestBF(x = .$attendedMINUSunattended, data = .,iterations=num.iter,rscale = sqrt(2)/2))})
  )%>%
  mutate(meanval = map(data, ~ mean(.x$attendedMINUSunattended))) %>%
  mutate(std = map(data, ~ sd(.x$attendedMINUSunattended))) %>%
  ungroup()%>%
  dplyr::select(-data, -time) %>%
  unnest(cols = c(stats, t_test_bf, meanval, std))%>%
  mutate(BF10 = bf, BF01 = 1/bf)%>%
  dplyr::select(RDK_colorlum, meanval, std,  statistic, parameter, p.value, BF10, BF01)%>%
  ungroup()%>%
  mutate(p.value = p.adjust(p.value, method="fdr")) %>% # none, holm
  # mutate(p.value = p.adjust(p.value, method="none")) %>% # none, holm
  ungroup()%>%
  mutate(CohensD = `statistic`/sqrt(parameter +1))%>%
  mutate(
    p.value = cell_spec(ifelse(round(p.value,4)<.001,"< .001",round(p.value,4)), 
                        color = ifelse(is.nan(p.value),"blue", ifelse(p.value < .05, "green", "red")),
                        bold = ifelse(is.nan(p.value),F, ifelse(p.value < .05, T,F)),
                        align = "center")
  ) %>%
  kbl(escape = F, digits = c(3,3,3,3,3,3,3,3,3), caption = c("central SSVEP | modulation | attended - unattended ")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))

```
#### analysis IIb

**modulation** ~ **COLOR ATTENTION** x **PERI STIM CONDITION**

- ANOVA
- post hoc contrast via emmeans

<br> 

```{r Stat central stimuli analysisIIb, message=FALSE, warning=FALSE, include=TRUE,fig.height=3, fig.width=3.5}
dat2plot <- DataIn %>%
  filter(RDK_position2=="center", RDK_colorlum=="isolum__to_bckgrd") %>%
  mutate(condition_label = case_when(
    condition %in% c(1,2) ~ "peri_AttUnatt",
    condition %in% c(3,4) ~ "peri_AttIrrel",
    condition %in% c(5,6) ~ "peri_UnattIrrel"
  ))%>%
  group_by(subjects, time, RDK_isattended, condition_label)%>%
  summarise(amplitude_evoked=mean(amplitude_evoked), modulation_evoked=mean(modulation_evoked))%>%
  filter(time != '[1 2] ')

#average data by mean amplitude across all conditions
aovmodel1_data <- dat2plot %>%
  filter(time == '[-1 0] ')%>%
  group_by(subjects)%>%
  mutate(amplitude_evoked_norm = (amplitude_evoked/mean(amplitude_evoked)-1)*100)

aovmodel1_data %>%
  ungroup()%>%
  group_by(condition_label,RDK_isattended)%>%
  summarise(
    n = n(),
    M=mean(amplitude_evoked_norm),
    SD=sd(amplitude_evoked_norm)
  )%>%
  kbl(escape = F, digits = c(5,5,5,5,5,5,5,5,5), caption = c("descriptives for central SSVEP pre-cue modulations (normalized by mean amplitudes)")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))

aovmodel1 <- aovmodel1_data%>%
  aov_ez(id="subjects", dv = "amplitude_evoked_norm", data = ., within = c("RDK_isattended","condition_label"),
         include_aov = afex_options("include_aov"))

# display table anova effects
aovmodel1 %>%
  anova()%>%
  tidy()%>%
  mutate(
    `p.value` = cell_spec(ifelse(round(`p.value`,4)<.001,"< .001",round(`p.value`,4)), 
                        color = ifelse(is.nan(`p.value`),"blue", ifelse(`p.value` < .05, "green", "red")),
                        bold = ifelse(is.nan(`p.value`),F, ifelse(`p.value` < .05, T,F)),
                        align = "center")
  ) %>%
  dplyr::select(term, `num.Df`, `den.Df`, MSE, `statistic`, ges, `p.value`) %>%
  kbl(escape = F, digits = c(5,5,5,5,5,5,5,5,5), 
      caption = c("repeated measures ANOVA for central SSVEP pre-cue modulations (normalized by mean amplitudes)")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))

#post-cue descriptives
dat2plot %>%
  filter(time == '[0.5 1.5] ') %>%
  ungroup()%>%
  group_by(condition_label,RDK_isattended)%>%
  summarise(
    n = n(),
    M=mean(modulation_evoked),
    SD=sd(modulation_evoked)
  )%>%
  kbl(escape = F, digits = c(5,5,5,5,5,5,5,5,5), caption = c("descriptives for central SSVEP post-cue modulations")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))

# post cue anova
aovmodel2 <- dat2plot %>%
  filter(time == '[0.5 1.5] ')%>%
  aov_ez(id="subjects", dv = "modulation_evoked", data = ., within = c("RDK_isattended","condition_label"),include_aov = afex_options("include_aov"))

# display table anova effects
aovmodel2 %>%
  anova()%>%
  tidy()%>%
  mutate(
    `p.value` = cell_spec(ifelse(round(`p.value`,4)<.001,"< .001",round(`p.value`,4)), 
                        color = ifelse(is.nan(`p.value`),"blue", ifelse(`p.value` < .05, "green", "red")),
                        bold = ifelse(is.nan(`p.value`),F, ifelse(`p.value` < .05, T,F)),
                        align = "center")
  ) %>%
  dplyr::select(term, `num.Df`, `den.Df`, MSE, `statistic`, ges, `p.value`) %>%
  kbl(escape = F, digits = c(5,5,5,5,5,5,5,5,5), caption = c("repeated measures ANOVA for central post-cue modulations")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))

#display main effects via emmeans
# Main effect of RDK_isattended
emm_ATT <- as.data.frame(emmeans(aovmodel2, ~ RDK_isattended))

# Main effect of condition_label
emm_Pericondition <- as.data.frame(emmeans(aovmodel2, ~ condition_label))

# RDK_isattended plot
ggplot(emm_ATT, aes(x = RDK_isattended, y = emmean, fill = RDK_isattended)) +
  geom_col(position = position_dodge(), width = 0.6) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width = 0.2) +
  labs(title = "Main Effect of RDK_isattended",
       y = "Estimated Marginal Means (95% CI)", x = "RDK_isattended") +
  theme_minimal()+
  scale_fill_manual(values=c("steelblue2", "#F03F3F"))+
  scale_color_manual(values=c("steelblue2", "#F03F3F"))+
  theme(axis.text.x = element_blank())

# condition_label plot
ggplot(emm_Pericondition, aes(x = condition_label, y = emmean, fill = condition_label)) +
  geom_col(position = position_dodge(), width = 0.6) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width = 0.2) +
  labs(title = "Main Effect of condition_label",
       y = "Estimated Marginal Means (95% CI)", x = "Condition Label") +
  theme_minimal()+
  scale_fill_brewer(palette = "Dark2")+
  scale_color_brewer(palette = "Dark2")+
  theme(axis.text.x = element_blank())

#post hoc contrasts
post_hocs.RDK_isattended <- emmeans(aovmodel2, c("RDK_isattended"), contr = "pairwise",adjust = "holm") # adjust = holm
post_hocs.condition_label <- emmeans(aovmodel2, c("condition_label"), contr = "pairwise",adjust = "holm") # adjust = holm

# report data for post_hocs.RDK_isattended
post_hocs.RDK_isattended$emmeans %>%
  kbl(escape = F, digits = c(3,3,3,3,3,3,3,3,3), caption = c("estimated marginal means | by ATTENTION | dv = central SSVEP modulation")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))

summary(post_hocs.RDK_isattended$contrasts) %>%
  mutate(
    p.value = cell_spec(ifelse(round(p.value,4)<.001,"< .001",round(p.value,4)), 
                        color = ifelse(is.nan(p.value),"blue", ifelse(p.value < .05, "green", "red")),
                        bold = ifelse(is.nan(p.value),F, ifelse(p.value < .05, T,F)),
                        align = "left")
  ) %>%
  # mutate(CohensD = `t.ratio`/sqrt(df+1))%>%
  mutate(`CohensD` =
           summary(eff_size(contrast(post_hocs.RDK_isattended, method = "pairwise", adjust = "holm"),
                            sigma = sqrt(mean(sigma(aovmodel2$lm)^2)), # RMS of sigma()
                            edf = df.residual(aovmodel2$lm), method = "identity"))$effect.size,
         `lowCI` =
           summary(eff_size(contrast(post_hocs.RDK_isattended, method = "pairwise", adjust = "holm"),
                            sigma = sqrt(mean(sigma(aovmodel2$lm)^2)), # RMS of sigma()
                            edf = df.residual(aovmodel2$lm), method = "identity"))$lower.CL,
         `highCI` =
           summary(eff_size(contrast(post_hocs.RDK_isattended, method = "pairwise", adjust = "holm"),
                            sigma = sqrt(mean(sigma(aovmodel2$lm)^2)), # RMS of sigma()
                            edf = df.residual(aovmodel2$lm), method = "identity"))$upper.CL
  )%>%
  kbl(escape = F, digits = c(3,3,3,3,3,3,3,3,3), 
        caption = c("contrasts for estimated marginal means |by ATTENTION | dv = central SSVEP modulation | corrected: Holm")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))

# report data for post_hocs.condition_label
post_hocs.condition_label$emmeans %>%
  kbl(escape = F, digits = c(3,3,3,3,3,3,3,3,3), caption = c("estimated marginal means | by PERI_CON | dv = central SSVEP modulation")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))

summary(post_hocs.condition_label$contrasts) %>%
  mutate(
    p.value = cell_spec(ifelse(round(p.value,4)<.001,"< .001",round(p.value,4)), 
                        color = ifelse(is.nan(p.value),"blue", ifelse(p.value < .05, "green", "red")),
                        bold = ifelse(is.nan(p.value),F, ifelse(p.value < .05, T,F)),
                        align = "left")
  ) %>%
  # mutate(CohensD = `t.ratio`/sqrt(df+1))%>%
  mutate(`CohensD` =
           summary(eff_size(contrast(post_hocs.condition_label, method = "pairwise", adjust = "holm"),
                            sigma = sqrt(mean(sigma(aovmodel2$lm)^2)), # RMS of sigma()
                            edf = df.residual(aovmodel2$lm), method = "identity"))$effect.size,
         `lowCI` =
           summary(eff_size(contrast(post_hocs.condition_label, method = "pairwise", adjust = "holm"),
                            sigma = sqrt(mean(sigma(aovmodel2$lm)^2)), # RMS of sigma()
                            edf = df.residual(aovmodel2$lm), method = "identity"))$lower.CL,
         `highCI` =
           summary(eff_size(contrast(post_hocs.condition_label, method = "pairwise", adjust = "holm"),
                            sigma = sqrt(mean(sigma(aovmodel2$lm)^2)), # RMS of sigma()
                            edf = df.residual(aovmodel2$lm), method = "identity"))$upper.CL
  )%>%
  kbl(escape = F, digits = c(3,3,3,3,3,3,3,3,3), 
        caption = c("contrasts for estimated marginal means |by PERI CON | dv = central SSVEP modulation | corrected: Holm")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))

# pairs(emmeans(aovmodel2, ~ RDK_isattended))
# pairs(emmeans(aovmodel2, ~ condition_label))
```

#### analysis IIc

**modulation** ~ **COLOR ATTENTION** x **PERI STIM CONDITION**

- linear mixed models
- post hoc contrast via emmeans

<br> 

```{r Stat central stimuli analysisIIc, message=FALSE, warning=FALSE, include=TRUE,fig.height=3, fig.width=3.5}
dat2plot <- DataIn %>%
  filter(RDK_position2=="center", RDK_colorlum=="isolum__to_bckgrd") %>%
  mutate(condition_label = case_when(
    condition %in% c(1,2) ~ "peri_AttUnatt",
    condition %in% c(3,4) ~ "peri_AttIrrel",
    condition %in% c(5,6) ~ "peri_UnattIrrel"
  ))%>%
  group_by(subjects, time, RDK_isattended, condition_label)%>%
  summarise(amplitude_evoked=mean(amplitude_evoked), modulation_evoked=mean(modulation_evoked))%>%
  filter(time != '[1 2] ')

#average data by mean amplitude across all conditions
LMMmodel1_data <- dat2plot %>%
  filter(time == '[-1 0] ')%>%
  group_by(subjects)%>%
  mutate(amplitude_evoked_norm = (amplitude_evoked/mean(amplitude_evoked)-1)*100)

lmmmodel1 <- LMMmodel1_data%>%
  mixed(
    amplitude_evoked ~ RDK_isattended * condition_label + (1 | subjects),
    data = .,
    method = "KR",  # Kenward-Roger approximation for p-values
    return = "afex_aov"  # ensures compatibility with emmeans
  )

# display table anova effects
lmmmodel1 %>%
  anova()%>%
  tidy()%>%
  mutate(
    `p.value` = cell_spec(ifelse(round(`p.value`,4)<.001,"< .001",round(`p.value`,4)), 
                        color = ifelse(is.nan(`p.value`),"blue", ifelse(`p.value` < .05, "green", "red")),
                        bold = ifelse(is.nan(`p.value`),F, ifelse(`p.value` < .05, T,F)),
                        align = "center")
  ) %>%
  dplyr::select(term, `num.Df`, `den.Df`, `statistic`, `p.value`) %>%
  kbl(escape = F, digits = c(5,5,5,5,5,5,5,5,5), 
      caption = c("Mixed Model Anova Table (Type 3 tests, KR-method) | central SSVEP pre-cue modulations (normalized by mean amplitudes)")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))



# post cue anova
lmmmodel2 <- dat2plot %>%
  filter(time == '[0.5 1.5] ')%>%
  mixed(
    modulation_evoked ~ RDK_isattended * condition_label + (1 | subjects),
    data = .,
    method = "KR",  # Kenward-Roger approximation for p-values
    return = "afex_aov"  # ensures compatibility with emmeans
  )

lmmmodel2 %>%
  anova()%>%
  tidy()%>%
  mutate(
    `p.value` = cell_spec(ifelse(round(`p.value`,4)<.001,"< .001",round(`p.value`,4)), 
                        color = ifelse(is.nan(`p.value`),"blue", ifelse(`p.value` < .05, "green", "red")),
                        bold = ifelse(is.nan(`p.value`),F, ifelse(`p.value` < .05, T,F)),
                        align = "center")
  ) %>%
  dplyr::select(term, `num.Df`, `den.Df`, `statistic`, `p.value`) %>%
  kbl(escape = F, digits = c(5,5,5,5,5,5,5,5,5), 
      caption = c("Mixed Model Anova Table (Type 3 tests, KR-method) | central SSVEP post-cue modulations")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))


#display main effects via emmeans
# Main effect of RDK_isattended
emm_ATT_lmm <- as.data.frame(emmeans(lmmmodel2, ~ RDK_isattended))

# Main effect of condition_label
emm_Pericondition_lmm <- as.data.frame(emmeans(lmmmodel2, ~ condition_label))

# RDK_isattended plot
ggplot(emm_ATT_lmm, aes(x = RDK_isattended, y = emmean, fill = RDK_isattended)) +
  geom_col(position = position_dodge(), width = 0.6) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width = 0.2) +
  labs(title = "Main Effect of RDK_isattended",
       y = "Estimated Marginal Means (95% CI)", x = "RDK_isattended") +
  theme_minimal()+
  scale_fill_manual(values=c("steelblue2", "#F03F3F"))+
  scale_color_manual(values=c("steelblue2", "#F03F3F"))+
  theme(axis.text.x = element_blank())

# condition_label plot
ggplot(emm_Pericondition_lmm, aes(x = condition_label, y = emmean, fill = condition_label)) +
  geom_col(position = position_dodge(), width = 0.6) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width = 0.2) +
  labs(title = "Main Effect of condition_label",
       y = "Estimated Marginal Means (95% CI)", x = "Condition Label") +
  theme_minimal()+
  scale_fill_brewer(palette = "Dark2")+
  scale_color_brewer(palette = "Dark2")+
  theme(axis.text.x = element_blank())

#post hoc contrasts identity
post_hocs.RDK_isattended_id <- emmeans(lmmmodel2, c("RDK_isattended"), contr = "identity",adjust = "FDR") # adjust = holm
post_hocs.condition_label_id <- emmeans(lmmmodel2, c("condition_label"), contr = "identity",adjust = "FDR") # adjust = holm

# report data for post_hoc attention
post_hocs.RDK_isattended_id%>%
  .$contrasts %>%
  tidy()%>%
  dplyr::rename(t.ratio=statistic, p.value=adj.p.value)%>%
  mutate(
    p.value = cell_spec(ifelse(round(p.value,4)<.001,"< .001",round(p.value,4)), 
                        color = ifelse(is.nan(p.value),"blue", ifelse(p.value < .05, "green", "red")),
                        bold = ifelse(is.nan(p.value),F, ifelse(p.value < .05, T,F)),
                        align = "left")
  ) %>% # mutate(CohensD = `t.ratio`/sqrt(df+1))%>%
  mutate(`CohensD` =
           summary(eff_size(post_hocs.RDK_isattended_id,
                            sigma = sqrt(mean(sigma(lmmmodel2$full_model)^2)), # RMS of sigma()
                            edf = df.residual(lmmmodel2$full_model), method = "identity"))$effect.size,
         `lowCI` =
           summary(eff_size(post_hocs.RDK_isattended_id,
                            sigma = sqrt(mean(sigma(lmmmodel2$full_model)^2)), # RMS of sigma()
                            edf = df.residual(lmmmodel2$full_model), method = "identity"))$lower.CL,
         `highCI` =
           summary(eff_size(post_hocs.RDK_isattended_id,
                            sigma = sqrt(mean(sigma(lmmmodel2$full_model)^2)), # RMS of sigma()
                            edf = df.residual(lmmmodel2$full_model), method = "identity"))$upper.CL
  )%>%
  kbl(escape = F, digits = c(3,3,3,3,3,3,3,3,3), 
      caption = c("estimated marginal means | by PERI_CON | dv = central SSVEP modulation | FDR corrected")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))

# report data for post_hoc condition_label
post_hocs.condition_label_id%>%
  .$contrasts %>%
  tidy()%>%
  dplyr::rename(t.ratio=statistic, p.value=adj.p.value)%>%
  mutate(
    p.value = cell_spec(ifelse(round(p.value,4)<.001,"< .001",round(p.value,4)), 
                        color = ifelse(is.nan(p.value),"blue", ifelse(p.value < .05, "green", "red")),
                        bold = ifelse(is.nan(p.value),F, ifelse(p.value < .05, T,F)),
                        align = "left")
  ) %>% # mutate(CohensD = `t.ratio`/sqrt(df+1))%>%
  mutate(`CohensD` =
           summary(eff_size(post_hocs.condition_label_id,
                            sigma = sqrt(mean(sigma(lmmmodel2$full_model)^2)), # RMS of sigma()
                            edf = df.residual(lmmmodel2$full_model), method = "identity"))$effect.size,
         `lowCI` =
           summary(eff_size(post_hocs.condition_label_id,
                            sigma = sqrt(mean(sigma(lmmmodel2$full_model)^2)), # RMS of sigma()
                            edf = df.residual(lmmmodel2$full_model), method = "identity"))$lower.CL,
         `highCI` =
           summary(eff_size(post_hocs.condition_label_id,
                            sigma = sqrt(mean(sigma(lmmmodel2$full_model)^2)), # RMS of sigma()
                            edf = df.residual(lmmmodel2$full_model), method = "identity"))$upper.CL
  )%>%
  kbl(escape = F, digits = c(3,3,3,3,3,3,3,3,3), 
      caption = c("estimated marginal means | by PERI_CON | dv = central SSVEP modulation | FDR corrected")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))




#post hoc contrasts paired
post_hocs.RDK_isattended <- emmeans(lmmmodel2, c("RDK_isattended"), contr = "pairwise",adjust = "FDR") # adjust = holm
post_hocs.condition_label <- emmeans(lmmmodel2, c("condition_label"), contr = "pairwise",adjust = "FDR") # adjust = holm


summary(post_hocs.RDK_isattended$contrasts) %>%
  mutate(
    p.value = cell_spec(ifelse(round(p.value,4)<.001,"< .001",round(p.value,4)), 
                        color = ifelse(is.nan(p.value),"blue", ifelse(p.value < .05, "green", "red")),
                        bold = ifelse(is.nan(p.value),F, ifelse(p.value < .05, T,F)),
                        align = "left")
  ) %>%
  # mutate(CohensD = `t.ratio`/sqrt(df+1))%>%
  mutate(`CohensD` =
           summary(eff_size(post_hocs.RDK_isattended,
                            sigma = sqrt(mean(sigma(lmmmodel2$full_model)^2)), # RMS of sigma()
                            edf = df.residual(lmmmodel2$full_model), method = "pairwise"))$effect.size,
         `lowCI` =
           summary(eff_size(post_hocs.RDK_isattended,
                            sigma = sqrt(mean(sigma(lmmmodel2$full_model)^2)), # RMS of sigma()
                            edf = df.residual(lmmmodel2$full_model), method = "pairwise"))$lower.CL,
         `highCI` =
           summary(eff_size(post_hocs.RDK_isattended,
                            sigma = sqrt(mean(sigma(lmmmodel2$full_model)^2)), # RMS of sigma()
                            edf = df.residual(lmmmodel2$full_model), method = "pairwise"))$upper.CL
  )%>%
  kbl(escape = F, digits = c(3,3,3,3,3,3,3,3,3), 
        caption = c("contrasts for estimated marginal means |by ATTENTION | dv = central SSVEP modulation | corrected: FDR")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))


summary(post_hocs.condition_label$contrasts) %>%
  mutate(
    p.value = cell_spec(ifelse(round(p.value,4)<.001,"< .001",round(p.value,4)), 
                        color = ifelse(is.nan(p.value),"blue", ifelse(p.value < .05, "green", "red")),
                        bold = ifelse(is.nan(p.value),F, ifelse(p.value < .05, T,F)),
                        align = "left")
  ) %>%
  # mutate(CohensD = `t.ratio`/sqrt(df+1))%>%
  mutate(`CohensD` =
           summary(eff_size(post_hocs.condition_label,
                            sigma = sqrt(mean(sigma(lmmmodel2$full_model)^2)), # RMS of sigma()
                            edf = df.residual(lmmmodel2$full_model), method = "pairwise"))$effect.size,
         `lowCI` =
           summary(eff_size(post_hocs.condition_label,
                            sigma = sqrt(mean(sigma(lmmmodel2$full_model)^2)), # RMS of sigma()
                            edf = df.residual(lmmmodel2$full_model), method = "pairwise"))$lower.CL,
         `highCI` =
           summary(eff_size(post_hocs.condition_label,
                            sigma = sqrt(mean(sigma(lmmmodel2$full_model)^2)), # RMS of sigma()
                            edf = df.residual(lmmmodel2$full_model), method = "pairwise"))$upper.CL
  )%>%
  kbl(escape = F, digits = c(3,3,3,3,3,3,3,3,3), 
        caption = c("contrasts for estimated marginal means |by PERI CON | dv = central SSVEP modulation | corrected: Holm")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))

# pairs(emmeans(aovmodel2, ~ RDK_isattended))
# pairs(emmeans(aovmodel2, ~ condition_label))
```

**amp diff** ~ **COLOR ATTENTION**

- t-test post-cue modulation against zero for attended and unattended color
- t-test difference of post-cue modulation for attended vs unattended color

<br> 

```{r Stat2 central stimuli, message=FALSE, warning=FALSE, include=TRUE}
dat2plot <- DataIn %>%
  filter(RDK_position2=="center") %>%
  group_by(subjects, time, RDK_isattended, RDK_colorlum)%>%
  summarise(subtraction_evoked=mean(subtraction_evoked), modulation_evoked=mean(modulation_evoked))%>%
  filter(time == '[0.5 1.5] ')

dat2plot %>%
  group_by(RDK_isattended, RDK_colorlum)%>%
  nest()%>%
  mutate(stats = map(data, ~broom::tidy(
    t.test(subtraction_evoked ~ 1, data = .)
  ))) %>%
  mutate(
    t_test_bf = map(data, ~{extractBF(ttestBF(x = .$subtraction_evoked, data = .,iterations=num.iter,rscale = sqrt(2)/2))})
  )%>%
  mutate(meanval = map(data, ~ mean(.x$subtraction_evoked))) %>%
  mutate(std = map(data, ~ sd(.x$subtraction_evoked))) %>%
  dplyr::select(-data) %>%
  unnest(cols = c(stats, t_test_bf, meanval, std))%>%
  mutate(BF10 = bf, BF01 = 1/bf)%>%
  dplyr::select(RDK_colorlum, RDK_isattended, meanval, std,  statistic, parameter, p.value, BF10, BF01)%>%
  mutate(p.value = p.adjust(p.value, method="holm")) %>% # none, holm
  # mutate(p.value = p.adjust(p.value, method="none")) %>% # none, holm
  ungroup()%>%
  mutate(CohensD = `statistic`/sqrt(parameter +1))%>%
  mutate(
    p.value = cell_spec(ifelse(round(p.value,4)<.001,"< .001",round(p.value,4)), 
                        color = ifelse(is.nan(p.value),"blue", ifelse(p.value < .05, "green", "red")),
                        bold = ifelse(is.nan(p.value),F, ifelse(p.value < .05, T,F)),
                        align = "center")
  ) %>%
  kbl(escape = F, digits = c(3,3,3,3,3,3,3,3,3), 
        caption = c("central SSVEP | amp diff | t-tests for modulation agains zero | Holm-corrected")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))



dat2plot %>%
  dplyr::select(-modulation_evoked)%>%
  pivot_wider(names_from = "RDK_isattended", values_from = "subtraction_evoked")%>%
  mutate(attendedMINUSunattended = `attended` -`not attended`)%>%
  group_by(time, RDK_colorlum)%>%
  nest()%>%
  mutate(stats = map(data, ~broom::tidy(
    t.test(attendedMINUSunattended ~ 1, data = .)
  ))) %>%
  mutate(
    t_test_bf = map(data, ~{extractBF(ttestBF(x = .$attendedMINUSunattended, data = .,iterations=num.iter,rscale = sqrt(2)/2))})
  )%>%
  mutate(meanval = map(data, ~ mean(.x$attendedMINUSunattended))) %>%
  mutate(std = map(data, ~ sd(.x$attendedMINUSunattended))) %>%
  ungroup()%>%
  dplyr::select(-data, -time) %>%
  unnest(cols = c(stats, t_test_bf, meanval, std))%>%
  mutate(BF10 = bf, BF01 = 1/bf)%>%
  dplyr::select(RDK_colorlum, meanval, std,  statistic, parameter, p.value, BF10, BF01)%>%
  # mutate(p.value = p.adjust(p.value, method="holm")) %>% # none, holm
  # mutate(p.value = p.adjust(p.value, method="none")) %>% # none, holm
  ungroup()%>%
  mutate(CohensD = `statistic`/sqrt(parameter +1))%>%
  mutate(
    p.value = cell_spec(ifelse(round(p.value,4)<.001,"< .001",round(p.value,4)), 
                        color = ifelse(is.nan(p.value),"blue", ifelse(p.value < .05, "green", "red")),
                        bold = ifelse(is.nan(p.value),F, ifelse(p.value < .05, T,F)),
                        align = "center")
  ) %>%
  kbl(escape = F, digits = c(3,3,3,3,3,3,3,3,3), caption = c("central SSVEP | amp diff | attended - unattended ")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))

```



